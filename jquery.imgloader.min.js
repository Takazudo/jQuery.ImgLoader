/*! jQuery.ImgLoader (https://github.com/Takazudo/jQuery.ImgLoader)
 * lastupdate: 2013-03-06
 * version: 0.3.0
 * author: Takeshi Takatsudo 'Takazudo' <takazudo@gmail.com>
 * License: MIT */
(function(){var t=[].slice,e={}.hasOwnProperty,r=function(t,r){function n(){this.constructor=t}for(var o in r)e.call(r,o)&&(t[o]=r[o]);return n.prototype=r.prototype,t.prototype=new n,t.__super__=r.prototype,t};(function(e,n){var o,i;return o=e.ImgLoaderNs={},o.support={},o.support.xhr2=null!=n.FormData,o.createCachedFunction=function(t){var r;return r={},function(n,o){return r[n]||(r[n]=e.Deferred(function(e){return t(e,n,o)}).promise()),r[n]}},o.fetchImg=o.createCachedFunction(function(t,r,n){var i,s,u,a;return u=new Image,s=function(){return u.onload=u.onerror=null},t.always(s),i=e(u),u.onload=function(){return t.resolve(i)},u.onerror=function(){return t.reject(i)},o.support.xhr2&&(null!=n?n.useXHR2:void 0)?(a=new o.Xhr2Request(r,{timeout:n.timeout}),t.xhr=a,a.on("progress",function(){return t.notify(a.currentLoadedInfo())}),a.on("loadend timeout",function(){return u.src=r}),a.send()):u.src=r}),function(){var t;return t={},o.loadImg=function(r,n,i){return e.Deferred(function(e){return o.fetchImg(r,{useXHR2:n,timeout:i}).progress(function(t){return e.notify(t)}).then(function(n){var o,i;return t[r]||(t[r]=n),o=t[r],i=o.clone(),t[r]=i,e.resolve(o)},function(t){return e.reject(t)})}).promise()}}(),i=function(t){return e.Deferred(function(e){return setTimeout(function(){return e.resolve()},t)})},o.Event=function(){function e(){this._callbacks={}}return e.prototype.on=function(t,e){var r,n,o,i,s;for(r=t.split(" "),i=0,s=r.length;s>i;i++)n=r[i],(o=this._callbacks)[n]||(o[n]=[]),this._callbacks[n].push(e);return this},e.prototype.one=function(t,e){return this.on(t,function(){return this.off(t,arguments.callee),e.apply(this,arguments)})},e.prototype.trigger=function(){var e,r,n,o,i,s,u;if(e=arguments.length>=1?t.call(arguments,0):[],n=e.shift(),o=null!=(u=this._callbacks)?u[n]:void 0){for(i=0,s=o.length;s>i&&(r=o[i],r.apply(this,e)!==!1);i++);return this}},e.prototype.off=function(t,e){var r,n,o,i,s,u;if(!t)return this._callbacks={},this;if(o=null!=(u=this._callbacks)?u[t]:void 0,!o)return this;if(!e)return delete this._callbacks[t],this;for(n=i=0,s=o.length;s>i;n=++i)if(r=o[n],r===e){o=o.slice(),o.splice(n,1),this._callbacks[t]=o;break}return this},e.prototype.bind=function(){return this.on.apply(this,arguments)},e.prototype.unbind=function(){return this.off.apply(this,arguments)},e}(),o.Xhr2Request=function(t){function n(t,r){this.url=t,n.__super__.constructor.apply(this,arguments),this.options=e.extend({timeout:1e4},r),this._prepare()}return r(n,t),n.prototype._prepare=function(){var t,e=this;return t=!1,this._request=new XMLHttpRequest,this._request.open("GET",this.url),this._request.timeout=this.options.timeout,this._request.onloadend=function(){return e.trigger("loadend")},this._request.onprogress=function(r){return t||(t=!0,e.totalSize=r.totalSize,e.trigger("firstprogress")),e.loadedSize=r.loaded,e.loadedRatio=e.loadedSize/e.totalSize,e.trigger("progress")},this._request.ontimeout=function(){return e.options.timeout},this},n.prototype.currentLoadedInfo=function(){return{totalSize:this.totalSize,loadedSize:this.loadedSize,loadedRatio:this.loadedRatio}},n.prototype.send=function(){return this._request.send(),this},n}(o.Event),o.LoaderItem=function(t){function n(t,e,r){this.src=t,this._useXHR2=null!=e?e:!0,this._timeout=null!=r?r:1e4,n.__super__.constructor.apply(this,arguments)}return r(n,t),n.prototype.load=function(){var t=this;return e.Deferred(function(e){return o.loadImg(t.src,t._useXHR2,t._timeout).progress(function(e){return t.trigger("progress",e)}).then(function(r){return t.$img=r,t.trigger("success",t.$img),t.trigger("complete",t.$img),e.resolve(t.$img)},function(r){return t.$img=r,t.trigger("error",t.$img),t.trigger("complete",t.$img),e.reject(t.$img)})})},n}(o.Event),o.AbstractLoader=function(t){function e(){e.__super__.constructor.apply(this,arguments)}return r(e,t),e.prototype._prepareProgressInfo=function(){var t,e,r;return t=this.items||this._presets,e=t.length,this.progressInfo=r={loadedFileCount:0,totalFileCount:e,loadedRatio:0},this.ratioPerItem=1/e,this},e.prototype._updateProgressInfo=function(t,e){var r,n;return n=this.progressInfo,r=e.loadedRatio*this.ratioPerItem,n.loadedRatio=n.loadedRatio+r-(t.lastLoadedRatio||0),n.loadedRatio>1&&(n.loadedRatio=1),t.lastLoadedRatio=r,this},e}(o.Event),o.BasicLoader=function(n){function i(t,e){this._useXHR2=null!=t?t:!0,this._timeout=null!=e?e:1e4,i.__super__.constructor.apply(this,arguments),this.items=[]}return r(i,n),i.prototype.add=function(t){var r;return"string"===e.type(t)&&(r=t,t=new o.LoaderItem(r,this._useXHR2,this._timeout)),this.items.push(t),t},i.prototype.load=function(){var r,n,i=this;return this._prepareProgressInfo(),n=this.progressInfo,r=e.map(this.items,function(t){return t.on("progress",function(e){return i._updateProgressInfo(t,e),i.trigger("progress",n)}),t.on("complete",function(t){return n.loadedFileCount+=1,o.support.xhr2&&i._useXHR2||(n.loadedRatio=n.loadedFileCount/n.totalFileCount,i.trigger("progress",n)),i.trigger("itemload",t,n)}),t.load()}),e.Deferred(function(o){return e.when.apply(i,r).always(function(){var r,s;return s=arguments.length>=1?t.call(arguments,0):[],r=e(s),n.loadedRatio=1,i.trigger("progress",n),i.trigger("allload",r,n),o.resolve(r,n)})}).promise()},i.prototype.kill=function(){var t,e,r,n;for(n=this.items,e=0,r=n.length;r>e;e++)t=n[e],t.off();return this.trigger("kill"),this.off(),this},i}(o.AbstractLoader),o.ChainLoader=function(t){function n(t,r,o,i){this._pipesize=t,this._delay=null!=r?r:0,this._useXHR2=o,this._timeout=i,n.__super__.constructor.apply(this,arguments),this._presets=[],this._inLoadCount=0,this._allDoneDefer=e.Deferred()}return r(n,t),n.prototype._finished=function(){return this.progressInfo.loadedFileCount===this._presets.length},n.prototype._nextLoadAllowed=function(){return this._inLoadCount<this._pipesize},n.prototype._getImgs=function(){return e(e.map(this._presets,function(t){return t.item.$img}))},n.prototype._handleNext=function(){var t,r,n=this;return r=this.progressInfo,this._finished()?this._allloadFired?this:(this._allloadFired=!0,t=this._getImgs(),this.trigger("progress",r),this.trigger("allload",t,r),this._allDoneDefer.resolve(t),this):(e.each(this._presets,function(t,e){var s;return s=e.item,e.started?!0:n._nextLoadAllowed()?(n._inLoadCount+=1,e.started=!0,s.on("progress",function(t){return n._updateProgressInfo(s,t),n.trigger("progress",r)}),s.on("complete",function(s){var u;return e.done=!0,u=function(){return r.loadedFileCount+=1,n._inLoadCount-=1,o.support.xhr2&&n._useXHR2||(r.loadedRatio=r.loadedFileCount/r.totalFileCount,n.trigger("progress",r)),n.trigger("itemload",s,r),e.defer.resolve(s),i(n._delay).done(function(){return n._handleNext()})},0===t?u():n._presets[t-1].defer.always(function(){return u()})}),s.load()):!1}),this)},n.prototype.add=function(t){var r,n;return"string"===e.type(t)&&(n=t,t=new o.LoaderItem(n,this._useXHR2,this._timeout)),r={item:t,done:!1,started:!1,defer:e.Deferred()},this._presets.push(r),r.defer},n.prototype.load=function(){return this._prepareProgressInfo(),this._handleNext(),this._allDoneDefer},n.prototype.kill=function(){var t,e,r,n;for(n=this._presets,e=0,r=n.length;r>e;e++)t=n[e],t.item.off();return this.trigger("kill"),this.off(),this},n}(o.AbstractLoader),o.LoaderFacade=function(){function r(t){var r,n,i,s,u;for(this.options=r=e.extend({srcs:[],pipesize:0,delay:100,timeout:1e4,useXHR2:!0},t),this.loader=r.pipesize?new o.ChainLoader(r.pipesize,r.delay,r.useXHR2,r.timeout):new o.BasicLoader(r.useXHR2,r.timeout),u=r.srcs,i=0,s=u.length;s>i;i++)n=u[i],this.loader.add(n)}var n,i,s,u,a;for(i=["bind","trigger","on","off","load","one","unbind","add","kill"],s=function(e){return r.prototype[e]=function(){var r;return r=arguments.length>=1?t.call(arguments,0):[],this.loader[e].apply(this.loader,r)}},u=0,a=i.length;a>u;u++)n=i[u],s(n);return r}.call(this),function(){var t,r,n,s,u;return n={},t=null,r=function(){return e.Deferred(function(r){return e(function(){return t=e('<div id="calcNaturalWH-tempholder"></div>').css({position:"absolute",left:"-9999px",top:"-9999px"}),e("body").append(t),r.resolve()})}).promise()},s=function(t){return null==t.naturalWidth||0===t.naturalWidth||null==t.naturalHeight||0===t.naturalHeight?!1:!0},u=function(r,o){var s;return r=r.clone(),s=r[0],e.Deferred(function(u){var a,l,d,c;return c={},r.css({width:"auto",height:"auto"}),a=e("<div></div>").append(r),t.append(a),l=0,d=function(){return c.width=s.naturalWidth||r.width(),c.height=s.naturalHeight||r.height(),l>10?(a.remove(),u.reject()):c.width&&c.height?(n[o],a.remove(),u.resolve(c)):(l++,i(100).done(function(){return d()}))},d()}).promise()},o.calcNaturalWH=o.createCachedFunction(function(t,e){return o.loadImg(e).then(function(o){var i,a;return i=o[0],s(i)?(a={width:i.naturalWidth,height:i.naturalHeight},n[e]=a,t.resolve(a,o)):r().done(function(){return u(o,e).then(function(e){return t.resolve(e,o)},function(){return t.reject()})})},function(){return t.reject()})})}(),e.loadImg=o.loadImg,e.ImgLoader=o.LoaderFacade,e.calcNaturalWH=o.calcNaturalWH})(jQuery,this,this.document)}).call(this);